#! /usr/bin/env bash
#
# Prepares files to be released.
#
# * release/glossary.html contains a template with static assets hosted by glstatic.net
# * release/glossary-page-template-$release_tag contains a template including static assets

set -eo pipefail

readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"

log() {
  echo >&2 "$@"
}

fail() {
  echo >&2 "$@"
  exit 1
}

cd "$SCRIPT_DIR/../dist"
rm -r index.html examples
release_tag="$(git describe --tags)"
release_tag_without_v=$(echo "$release_tag" | sed 's/^v//')
major=$(echo "$release_tag_without_v" | sed 's/^\([^\.]*\)\.\([^\.]*\)\.\(.*\)$/\1/')

# Use release number in static asset file names instead of hash
mv assets/glossary.*.js "glossary-$release_tag".min.js
mv assets/glossary.*.css "glossary-$release_tag".min.css

for template in glossary empty; do
  cat $template.html | \
    sed 's!/assets/glossary.[^\.]*.js!'"glossary-$release_tag"'.min.js!' | \
    sed 's!/assets/glossary.[^\.]*.css!'"glossary-$release_tag"'.min.css!' \
    >$template-with-correct-file-names.html

  cat $template.html | \
    sed 's!/assets/glossary.[^\.]*.js!'"https://glstatic.net/glossary-page-template@$major/glossary"'.min.js!' | \
    sed 's!/assets/glossary.[^\.]*.css!'"https://glstatic.net/glossary-page-template@$major/glossary"'.min.css!' \
    >$template-with-cdn-links.html

  mv $template-with-correct-file-names.html $template.html
done

rmdir assets
cd ..

mkdir -p release
mv dist/glossary-with-cdn-links.html release/glossary.html
mv dist/empty-with-cdn-links.html release/empty.html

package_without_cdn="glossary-page-template-$release_tag"
mv dist "$package_without_cdn"
tar -zvcf "${package_without_cdn}.tar.gz" "$package_without_cdn"
rm -rf "$package_without_cdn"
mv "${package_without_cdn}.tar.gz" release
