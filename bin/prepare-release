#! /usr/bin/env bash
#
# Prepares files to be released.
#
# * release/glossary.html contains a template with static assets hosted by glstatic.net
# * release/glossary-page-template-$release_tag contains a template including static assets

set -eo pipefail

readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"

log() {
  echo >&2 "$@"
}

fail() {
  echo >&2 "$@"
  exit 1
}

cd "$SCRIPT_DIR/../dist"
rm -r index.html examples
release_tag="$(git describe --tags)"
release_tag_without_v=$(echo "$release_tag" | sed 's/^v//')
major=$(echo "$release_tag_without_v" | sed 's/^\([^\.]*\)\.\([^\.]*\)\.\(.*\)$/\1/')

# Use release number in static asset file names instead of hash
mv assets/index-*.js "glossary-$release_tag".min.js
mv assets/index-*.css "glossary-$release_tag".min.css

for template in glossary empty; do
  cat $template.html | \
    sed 's!/assets/index-[^\.]*.js!'"glossary-$release_tag"'.min.js!' | \
    sed 's!/assets/index-[^\.]*.css!'"glossary-$release_tag"'.min.css!' \
    >$template-with-correct-file-names.html

  cat $template.html | \
    sed 's!/assets/index-.[^\.]*.js!'"https://glstatic.net/glossary-page-template@$major/glossary"'.min.js!' | \
    sed 's!/assets/index-.[^\.]*.css!'"https://glstatic.net/glossary-page-template@$major/glossary"'.min.css!' | \
    sed 's!link rel="stylesheet" href!link rel="stylesheet" crossorigin href!' \
    >$template-with-cdn-links.html

  mv $template-with-correct-file-names.html $template.html
done

rmdir assets
cd ..

mkdir -p release

cat > dist/README.md <<EOF
# Glossary Page Template

This page includes a web interface for making changes that are saved back to the HTML file itself. This is meant to be used _locally_ by a _single user_ at a time and works best if the file is kept under version control.

If you're on macOS, Linux, or Cygwin and have Node.js installed, then just run

sed -n '/START OF editor.js\$/,\$p' glossary.html | node

You can hide these instructions altogether by setting the \`data-enable-help-for-making-changes\` attribute to \`false\` on the <div id="glossary-page-container"> element.
EOF

mv dist/glossary-with-cdn-links.html release/glossary.html
mv dist/empty-with-cdn-links.html release/empty.html

package_without_cdn="glossary-page-template-$release_tag"
mv dist "$package_without_cdn"
tar -zvcf "${package_without_cdn}.tar.gz" "$package_without_cdn"
rm -rf "$package_without_cdn"
mv "${package_without_cdn}.tar.gz" release
